<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Chatbot QA Tools</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f7f9fc; --fg:#0b1020; --muted:#5a6a85; --card:#ffffff; --accent:#2563eb; --danger:#e11d48; --ok:#10b981;
      --border:#e5e9f2; --soft:#f0f4fa;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --sans: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --shadow: 0 8px 24px rgba(0,0,0,.08);
    }
    .dark{
      --bg:#0b1020; --fg:#e8ecf1; --muted:#aab3c5; --card:#121830; --accent:#4da3ff; --danger:#ff5c7a; --ok:#21d19f;
      --border:#273054; --soft:#0e1430;
      --shadow: 0 8px 24px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 var(--sans);}
    a{color:#0b5ad9;text-decoration:none} a:hover{text-decoration:underline}
    .dark a{color:#a7c8ff}
    .wrap{max-width:980px;margin:26px auto;padding:0 16px;}
    .card{background:var(--card);border-radius:14px;padding:16px 18px;box-shadow:var(--shadow);margin-bottom:16px;border:1px solid var(--border)}
    h1{font-size:20px;margin:0 0 4px}
    h2{font-size:16px;margin:0 0 8px}
    .toprow{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .guide{font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0}
    .grow{flex:1}
    label{display:block;margin:10px 0 6px;font-weight:600;color:var(--muted)}
    input[type=text]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--fg);font-family:var(--mono)}
    .dark input[type=text]{background:var(--soft);border-color:#2a3558}
    input[type=text]::placeholder{color:#8a97ad}
    button{appearance:none;border:0;border-radius:10px;padding:10px 14px;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
    button.secondary{background:#7087a7;color:#fff}
    .dark button.secondary{background:#2a3558}
    button.danger{background:var(--danger)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .logs{white-space:pre-wrap;background:#fff;border-radius:10px;padding:12px;font-family:var(--mono);font-size:13px;max-height:440px;overflow:auto;border:1px solid var(--border)}
    .dark .logs{background:var(--soft);border-color:#273054}
    .muted{color:var(--muted)}
    .pill{display:inline-block;background:#eef3ff;border:1px solid var(--border);padding:4px 8px;border-radius:999px;margin:3px 6px 0 0;font-family:var(--mono);font-size:12px;color:#113a9b;cursor:pointer}
    .dark .pill{background:#1b2446;border-color:#2a3558;color:#cfe1ff}
    .hint{font-size:12px;color:#71809b;margin-top:6px}
    .sep{height:1px;background:var(--border);margin:14px 0}
    .success{color:var(--ok)}
    .error{color:var(--danger)}
    .kbd{border:1px solid var(--border);border-bottom-width:2px;border-radius:6px;padding:0 6px;display:inline-block;line-height:20px;background:#fff;font-family:var(--mono)}
    .dark .kbd{background:var(--soft);border-color:#3a456e}
    .small{font-size:12px}
    .code{font-family:var(--mono);background:#fff;border:1px solid var(--border);border-radius:8px;padding:6px 8px;display:inline-block}
    .dark .code{background:var(--soft);border-color:#273054}
    .autocomplete{position:relative;}
    .ac-list{
      position:absolute;left:0;right:0;top:100%;z-index:10;background:var(--card);border:1px solid var(--border);
      border-radius:10px;margin-top:6px;box-shadow:var(--shadow);overflow:hidden;display:none;
    }
    .ac-item{padding:10px 12px;cursor:pointer;border-top:1px solid var(--border);}
    .ac-item:first-child{border-top:none}
    .ac-item:hover, .ac-item.active{background:var(--soft)}
    .badge{font-size:11px;border:1px solid var(--border);padding:2px 6px;border-radius:999px;margin-left:8px;color:var(--muted)}
    .help{background:#eef6ff;border:1px dashed var(--border);border-radius:10px;padding:10px;margin-top:10px;color:#0b1020;display:none}
    .dark .help{background:#0f1a36;color:#e8ecf1}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="toprow">
        <div>
          <h1>Chatbot QA Tools</h1>
          <div class="muted">Ch·∫°y tool, xem log, x√≥a d√≤ng l·ªói t·ª± ƒë·ªông t·ª´ log, t·∫£i file ƒë√£ ch·ªânh s·ª≠a.</div>
        </div>
        <div class="guide">
          üìò <a href="https://docs.google.com/document/d/1TnY6_Dn2Sg5DzIaXpKrUBzRIFrTy9c534mR2DMijsMg/edit?usp=sharing" target="_blank" rel="noopener">H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</a>
          <span class="badge"><button id="themeBtn" class="secondary" style="padding:6px 10px;border-radius:8px">Dark/Light</button></span>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Ch·∫°y l·ªánh</h2>

      <div class="autocomplete">
        <label for="cmd">L·ªánh (g·ª£i √Ω; nh·∫•n <span class="kbd">Tab</span> ƒë·ªÉ nh·∫≠n, ho·∫∑c click)</label>
        <input id="cmd" type="text" placeholder="v√≠ d·ª•: mi https://drive.google.com/file/d/.../view?usp=sharing" autocomplete="off" />
        <div id="acList" class="ac-list"></div>
      </div>

      <div class="hint">
        G·ª£i √Ω nhanh:
        <span class="pill">civitek</span>
        <span class="pill">civitek new</span>
        <span class="pill">flager</span>
        <span class="pill">mi</span>
        <span class="pill">md</span>
        <span class="pill">md new</span>
        <span class="pill">help</span>
      </div>

      <div class="row">
        <button id="runBtn">Ch·∫°y l·ªánh</button>
        <button id="deleteBtn" class="danger" disabled>X√≥a d√≤ng l·ªói (t·ª± l·∫•y ID t·ª´ log)</button>
        <button id="zipBtn" class="secondary" disabled>T·∫£i file _content.txt ƒë√£ s·ª≠a (ZIP)</button>
        <button id="clearBtn" class="secondary">X√≥a log</button>
      </div>

      <div class="sep"></div>
      <div class="muted" id="status">S·∫µn s√†ng.</div>
      <div id="helpBox" class="help"></div>
      <div class="logs" id="logs" aria-live="polite"></div>
    </div>

    <div class="card">
      <h2>Ph√¢n t√≠ch link (t√πy ch·ªçn)</h2>
      <label for="probeUrl">Link Google Drive (ZIP) ho·∫∑c URL th∆∞·ªùng</label>
      <input id="probeUrl" type="text" placeholder="https://drive.google.com/file/d/.../view?usp=sharing" />
      <div class="row">
        <button id="probeBtn" class="secondary">Ph√¢n t√≠ch link</button>
      </div>
      <div id="probeResult" class="small muted"></div>
    </div>
  </div>

  <script>
    /* Same-origin API */
    function api(path){
      const base = window.location.origin;
      return base + (path.startsWith('/api') ? path : '/api' + path);
    }

    const COMMANDS = ["civitek","civitek new","flager","mi","md","md new","help"];
    let lastJob = { data_dir: null, log_text: "" };
    let dark = false;

    const themeBtn = document.getElementById('themeBtn');
    themeBtn.addEventListener('click', () => {
      dark = !dark;
      document.body.classList.toggle('dark', dark);
    });

    const cmdEl = document.getElementById('cmd');
    const runBtn = document.getElementById('runBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const zipBtn = document.getElementById('zipBtn');
    const clearBtn = document.getElementById('clearBtn');
    const statusEl = document.getElementById('status');
    const logsEl = document.getElementById('logs');
    const helpBox = document.getElementById('helpBox');

    const probeUrlEl = document.getElementById('probeUrl');
    const probeBtn = document.getElementById('probeBtn');
    const probeResult = document.getElementById('probeResult');

    /* ===== Autocomplete dropdown (Tab/click only). Enter = ch·∫°y l·ªánh ===== */
    const acList = document.getElementById('acList');
    let acIndex = -1;

    function showAC(items){
      acList.innerHTML = '';
      if (!items.length){ acList.style.display = 'none'; return; }
      items.forEach((txt, idx)=>{
        const div = document.createElement('div');
        div.className = 'ac-item' + (idx===0?' active':'');
        if (idx===0) acIndex = 0;
        div.textContent = txt;
        div.addEventListener('mousedown', (e)=>{ e.preventDefault(); acceptAC(txt); });
        acList.appendChild(div);
      });
      acList.style.display = 'block';
    }
    function hideAC(){ acList.style.display = 'none'; acIndex = -1; }

    function acceptAC(txt){
      const cur = cmdEl.value.trim();
      const parts = cur.split(/\s+/);
      let rest = '';
      if (parts.length >= 2){
        if (/^https?:\/\//i.test(parts[1])) rest = ' ' + parts.slice(1).join(' ');
        else if (parts.length > 2) rest = ' ' + parts.slice(2).join(' ');
      }
      const suffix = (txt === 'help' || rest) ? '' : ' ';
      cmdEl.value = txt + rest + suffix;
      hideAC();
      cmdEl.focus();
    }

    function moveAC(delta){
      const items = Array.from(acList.querySelectorAll('.ac-item'));
      if (!items.length) return;
      acIndex = (acIndex + delta + items.length) % items.length;
      items.forEach((el,i)=> el.classList.toggle('active', i===acIndex));
    }
    function activeACText(){
      const el = acList.querySelector('.ac-item.active');
      return el ? el.textContent : null;
    }

    cmdEl.addEventListener('input', ()=>{
      const val = cmdEl.value.trim().toLowerCase();
      if (!val){ hideAC(); return; }
      const matches = COMMANDS.filter(c => c.startsWith(val));
      if (!matches.length){
        const first = val.split(/\s+/).slice(0,2).join(' ');
        const alt = COMMANDS.filter(c => c.startsWith(first));
        showAC(alt);
      } else {
        showAC(matches);
      }
    });

    // Tab nh·∫≠n g·ª£i √Ω; Enter ch·∫°y l·ªánh (kh√¥ng autocomplete)
    cmdEl.addEventListener('keydown', (e)=>{
      if (acList.style.display === 'block'){
        if (e.key === 'ArrowDown'){ e.preventDefault(); moveAC(1); }
        else if (e.key === 'ArrowUp'){ e.preventDefault(); moveAC(-1); }
        else if (e.key === 'Tab'){
          const t = activeACText();
          if (t){ e.preventDefault(); acceptAC(t); }
        } else if (e.key === 'Escape'){
          hideAC();
        } else if (e.key === 'Enter'){
          e.preventDefault();
          runBtn.click();
        }
      } else {
        if (e.key === 'Tab'){
          const val = cmdEl.value.trim().toLowerCase();
          const m = COMMANDS.filter(c=>c.startsWith(val));
          if (m.length){ e.preventDefault(); acceptAC(m[0]); }
        } else if (e.key === 'Enter'){
          e.preventDefault();
          runBtn.click();
        }
      }
    });

    document.addEventListener('click', (e)=>{
      if (!acList.contains(e.target) && e.target !== cmdEl) hideAC();
    });

    /* ===== Helpers ===== */
    function appendLog(msg, css='') {
      if (!msg) return;
      const line = document.createElement('div');
      if (css) line.className = css;
      line.textContent = msg;
      logsEl.appendChild(line);
      logsEl.scrollTop = logsEl.scrollHeight;
    }
    function setStatus(msg){ statusEl.textContent = msg; }
    function extractIdsFromLog(text) {
      const ids = new Set();
      const re = /\bID\s*:\s*([A-Za-z0-9._\-]+)/ig;
      let m; while ((m = re.exec(text)) !== null) ids.add(m[1]);
      return Array.from(ids);
    }
    async function callJSON(url, body) {
      const res = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body || {})
      });
      if (!res.ok) {
        const t = await res.text().catch(()=> 'Request error');
        throw new Error(`HTTP ${res.status}: ${t}`);
      }
      return res.json();
    }
    function showHelpBox(text){ helpBox.textContent = text || ''; helpBox.style.display = 'block'; }
    function hideHelpBox(){ helpBox.textContent = ''; helpBox.style.display = 'none'; }

    /* ===== Run / Delete / Download flow ===== */
    runBtn.addEventListener('click', async () => {
      const command = cmdEl.value.trim();
      if (!command) { alert('Nh·∫≠p l·ªánh'); return; }

      runBtn.disabled = true; deleteBtn.disabled = true; zipBtn.disabled = true;
      setStatus('ƒêang g·ª≠i l·ªánh...');
      logsEl.innerHTML = ''; hideHelpBox();

      try {
        const start = await callJSON(api('/run-tool-async'), { command });
        const jobId = start.job_id;
        appendLog(`üîé Job: ${jobId}`);

        let done = false, dataDir = null, resultText = '', isHelp = false;
        while (!done) {
          const j = await fetch(api(`/job/${jobId}`)).then(r=>r.json());
          if (j.status === 'done') {
            done = true;
            const r = j.result || {};
            isHelp = !!r.help;                                // <-- x·ª≠ l√Ω help
            resultText = (r.result ?? r.output ?? '') + '';
            dataDir = r.data_dir || null;

            if (resultText) appendLog(resultText);
            setStatus('Ho√†n t·∫•t.');

            if (isHelp){
              // help ch·ªâ hi·ªán h∆∞·ªõng d·∫´n, kh√¥ng tr√≠ch ID/kh√¥ng b·∫≠t x√≥a
              showHelpBox(resultText);
              lastJob = { data_dir:null, log_text:'' };
              runBtn.disabled = false;
              deleteBtn.disabled = true;
              zipBtn.disabled = true;
              return;
            }
          } else if (j.status === 'error') {
            done = true;
            setStatus('L·ªói.');
            appendLog(`‚ùå ${j.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}`, 'error');
          } else {
            setStatus('ƒêang x·ª≠ l√Ω...');
            await new Promise(rs=>setTimeout(rs, 900));
          }
        }

        lastJob = { data_dir: dataDir, log_text: resultText };
        const ids = extractIdsFromLog(resultText);
        deleteBtn.disabled = !(ids.length && dataDir);
        zipBtn.disabled = !dataDir;

        if (!dataDir) appendLog('‚ö†Ô∏è Kh√¥ng c√≥ data_dir t·ª´ server n√™n kh√¥ng th·ªÉ x√≥a d√≤ng l·ªói t·ª± ƒë·ªông.', 'error');
        else appendLog(`üìÅ Data dir: ${dataDir}`, 'muted');

        if (ids.length) appendLog(`üßæ Tr√≠ch ƒë∆∞·ª£c ${ids.length} ID l·ªói t·ª´ log.`);
        else appendLog('‚ÑπÔ∏è Kh√¥ng tr√≠ch ƒë∆∞·ª£c ID l·ªói n√†o trong log.', 'muted');
      } catch (e) {
        appendLog(`‚ùå ${e.message}`, 'error');
        setStatus('L·ªói.');
      } finally {
        runBtn.disabled = false;
      }
    });

    clearBtn.addEventListener('click', () => {
      logsEl.innerHTML = '';
      hideHelpBox();
      setStatus('ƒê√£ x√≥a log.');
      deleteBtn.disabled = true;
      zipBtn.disabled = true;
    });

    deleteBtn.addEventListener('click', async () => {
      if (!lastJob.data_dir) { alert('Ch∆∞a c√≥ data_dir. H√£y ch·∫°y tool tr∆∞·ªõc.'); return; }
      if (!lastJob.log_text) { alert('Ch∆∞a c√≥ log ƒë·ªÉ tr√≠ch ID.'); return; }

      try {
        const dry = await callJSON(api('/delete-error-lines'), {
          data_dir: lastJob.data_dir,
          log_text: lastJob.log_text,
          dry_run: true
        });
        const idsCount = (dry.ids || []).length;
        const files = dry.targets || [];
        if (!idsCount) { alert('Kh√¥ng t√¨m th·∫•y ID l·ªói trong log.'); return; }
        const ok = confirm(`S·∫Ω x√≥a c√°c d√≤ng ch·ª©a ${idsCount} ID trong ${files.length} file:\n- ${files.join('\n- ')}\n\nB·∫°n ch·∫Øc ch·∫Øn?`);
        if (!ok) return;

        const res = await callJSON(api('/delete-error-lines'), {
          data_dir: lastJob.data_dir,
          log_text: lastJob.log_text,
          dry_run: false
        });
        appendLog(`‚úÖ ƒê√£ x√≥a: ${res.deleted_total} d√≤ng trong ${res.reports.length} file.`, 'success');
        res.reports.forEach(r => {
          if (r.error) appendLog(`‚Ä¢ ${r.file}: ${r.error}`, 'error');
          else appendLog(`‚Ä¢ ${r.file}: removed ${r.removed}, kept ${r.kept}`);
        });

        const modified = res.modified_files || [];
        if (modified.length === 1) {
          const url = api(`/api/download-cleaned-one?data_dir=${encodeURIComponent(lastJob.data_dir)}&name=${encodeURIComponent(modified[0])}`);
          window.open(url, "_blank");
        } else if (modified.length > 1) {
          const url = api(`/api/download-cleaned?data_dir=${encodeURIComponent(lastJob.data_dir)}&names=${encodeURIComponent(modified.join(","))}`);
          window.open(url, "_blank");
        } else {
          appendLog('‚ÑπÔ∏è Kh√¥ng c√≥ file n√†o thay ƒë·ªïi (c√≥ th·ªÉ kh√¥ng line n√†o kh·ªõp ID).', 'muted');
        }
      } catch (e) {
        appendLog(`‚ùå ${e.message}`, 'error');
      }
    });

    /* T·∫£i ZIP file _content.txt ƒë√£ s·ª≠a (n·∫øu ch·ªâ b·∫•m ri√™ng) */
    zipBtn.addEventListener('click', ()=>{
      const dataDir = lastJob.data_dir;
      if (!dataDir){ alert('Ch∆∞a c√≥ d·ªØ li·ªáu. H√£y ch·∫°y tool tr∆∞·ªõc.'); return; }
      const url = api(`/api/download-cleaned?data_dir=${encodeURIComponent(dataDir)}`);
      window.open(url, "_blank");
    });

    /* Ph√¢n t√≠ch link */
    probeBtn.addEventListener('click', async () => {
      const url = probeUrlEl.value.trim();
      if (!url) { alert('Nh·∫≠p link c·∫ßn ph√¢n t√≠ch'); return; }
      probeBtn.disabled = true;
      probeResult.textContent = 'ƒêang ph√¢n t√≠ch...';
      try {
        const res = await callJSON(api('/analyze-by-url'), { url });
        const vis = res.visibility || {};
        const ok = res.ok;
        const lines = [];
        lines.push(`K·∫øt qu·∫£: ${ok ? 'OK' : 'L·ªñI'}`);
        if (vis.public !== undefined) {
          lines.push(`Quy·ªÅn chia s·∫ª: ${vis.public ? 'C√¥ng khai / Truy c·∫≠p ƒë∆∞·ª£c' : 'Kh√¥ng c√¥ng khai'}`);
          if (vis.reason) lines.push(`L√Ω do: ${vis.reason}`);
        }
        const sum = (res.result && res.result.summary) || {};
        if (sum.num_entries_in_zip !== undefined) {
          lines.push(`S·ªë entry trong ZIP: ${sum.num_entries_in_zip}`);
          if (sum.sample_first_10 && sum.sample_first_10.length) {
            lines.push('V√≠ d·ª• 10 file ƒë·∫ßu:');
            sum.sample_first_10.forEach(n => lines.push('  - ' + n));
          }
        }
        probeResult.textContent = lines.join('\n');
      } catch (e) {
        probeResult.textContent = `L·ªói: ${e.message}`;
      } finally {
        probeBtn.disabled = false;
      }
    });

    /* Click g·ª£i √Ω nhanh */
    document.querySelectorAll('.pill').forEach(p => {
      p.addEventListener('click', () => {
        const cmd = p.textContent.trim();
        const cur = cmdEl.value.trim();
        if (!cur || !cur.startsWith(cmd)) {
          cmdEl.value = cmd + (cmd === 'help' ? '' : ' ');
          cmdEl.focus();
          const ev = new Event('input');
          cmdEl.dispatchEvent(ev);
        }
      });
    });
  </script>
</body>
</html>
