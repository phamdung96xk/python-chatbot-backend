<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Chatbot QA Tools</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1020; --fg:#e8ecf1; --muted:#aab3c5; --card:#121830; --accent:#4da3ff; --danger:#ff5c7a; --ok:#21d19f;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --sans: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 var(--sans);}
    a{color:#a7c8ff;text-decoration:none} a:hover{text-decoration:underline}
    .wrap{max-width:980px;margin:26px auto;padding:0 16px;}
    .card{background:var(--card);border-radius:14px;padding:16px 18px;box-shadow:0 6px 24px rgba(0,0,0,.25);margin-bottom:16px}
    h1{font-size:20px;margin:0 0 4px}
    h2{font-size:16px;margin:0 0 8px}
    .toprow{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .guide{font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0}
    .grow{flex:1}
    label{display:block;margin:10px 0 6px;font-weight:600;color:var(--muted)}
    input[type=text]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3558;background:#0e1430;color:var(--fg);font-family:var(--mono)}
    input[type=text]::placeholder{color:#6f7995}
    button{appearance:none;border:0;border-radius:10px;padding:10px 14px;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
    button.secondary{background:#2a3558}
    button.danger{background:var(--danger)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .logs{white-space:pre-wrap;background:#0e1430;border-radius:10px;padding:12px;font-family:var(--mono);font-size:13px;max-height:440px;overflow:auto;border:1px solid #273054}
    .muted{color:var(--muted)}
    .pill{display:inline-block;background:#1b2446;border:1px solid #2a3558;padding:4px 8px;border-radius:999px;margin:3px 6px 0 0;font-family:var(--mono);font-size:12px;color:#cfe1ff;cursor:pointer}
    .hint{font-size:12px;color:#91a2c6;margin-top:6px}
    .sep{height:1px;background:#233054;margin:14px 0}
    .success{color:var(--ok)}
    .error{color:var(--danger)}
    .kbd{border:1px solid #3a456e;border-bottom-width:2px;border-radius:6px;padding:0 6px;display:inline-block;line-height:20px;background:#0e1430;font-family:var(--mono)}
    .save{font-size:12px;margin-left:8px;color:#9bb3e8;cursor:pointer}
    .small{font-size:12px}
    .code{font-family:var(--mono);background:#0e1430;border:1px solid #273054;border-radius:8px;padding:6px 8px;display:inline-block}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- CARD: Header + Backend -->
    <div class="card">
      <div class="toprow">
        <div>
          <h1>Chatbot QA Tools</h1>
          <div class="muted">Ch·∫°y tool, xem log, x√≥a d√≤ng l·ªói t·ª± ƒë·ªông t·ª´ log, t·∫£i file ƒë√£ ch·ªânh s·ª≠a.</div>
        </div>
        <div class="guide">
          üìò <a href="https://docs.google.com/document/d/1TnY6_Dn2Sg5DzIaXpKrUBzRIFrTy9c534mR2DMijsMg/edit?usp=sharing" target="_blank" rel="noopener">H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</a>
        </div>
      </div>

      <label for="backend">Backend URL <span id="saveBackend" class="save" title="L∆∞u v√†o tr√¨nh duy·ªát">(l∆∞u)</span></label>
      <input id="backend" type="text" placeholder="https://your-app.onrender.com" />
      <div class="small muted">M·∫πo: c√≥ th·ªÉ d√°n lu√¥n ƒë∆∞·ªùng d·∫´n nh∆∞ <span class="code">https://python-chatbot-backend-xxxx.onrender.com</span></div>
    </div>

    <!-- CARD: Ch·∫°y l·ªánh -->
    <div class="card">
      <h2>Ch·∫°y l·ªánh</h2>
      <label for="cmd">L·ªánh (autocomplete; nh·∫•n <span class="kbd">Tab</span> ƒë·ªÉ nh·∫≠n g·ª£i √Ω)</label>
      <input id="cmd" type="text" placeholder="v√≠ d·ª•: mi https://drive.google.com/file/d/.../view?usp=sharing" autocomplete="off" />

      <div class="hint">
        G·ª£i √Ω nhanh:
        <span class="pill">civitek</span>
        <span class="pill">civitek new</span>
        <span class="pill">flager</span>
        <span class="pill">mi</span>
        <span class="pill">md</span>
        <span class="pill">md new</span>
        <span class="pill">help</span>
      </div>

      <div class="row">
        <button id="runBtn">Ch·∫°y l·ªánh</button>
        <button id="deleteBtn" class="danger" disabled>X√≥a d√≤ng l·ªói (t·ª± l·∫•y ID t·ª´ log)</button>
        <button id="clearBtn" class="secondary">X√≥a log</button>
      </div>

      <div class="sep"></div>
      <div class="muted" id="status">S·∫µn s√†ng.</div>
      <div class="logs" id="logs" aria-live="polite"></div>
    </div>

    <!-- CARD: Ph√¢n t√≠ch link (t√πy ch·ªçn) -->
    <div class="card">
      <h2>Ph√¢n t√≠ch link (t√πy ch·ªçn)</h2>
      <label for="probeUrl">Link Google Drive (ZIP) ho·∫∑c URL th∆∞·ªùng</label>
      <input id="probeUrl" type="text" placeholder="https://drive.google.com/file/d/.../view?usp=sharing" />
      <div class="row">
        <button id="probeBtn" class="secondary">Ph√¢n t√≠ch link</button>
      </div>
      <div id="probeResult" class="small muted"></div>
    </div>
  </div>

  <script>
    // ====== Autocomplete l·ªánh v·ªõi Tab ======
    const COMMANDS = ["civitek","civitek new","flager","mi","md","md new","help"];

    const backendEl = document.getElementById('backend');
    const saveBackendEl = document.getElementById('saveBackend');
    const cmdEl = document.getElementById('cmd');
    const runBtn = document.getElementById('runBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const clearBtn = document.getElementById('clearBtn');
    const statusEl = document.getElementById('status');
    const logsEl = document.getElementById('logs');

    const probeUrlEl = document.getElementById('probeUrl');
    const probeBtn = document.getElementById('probeBtn');
    const probeResult = document.getElementById('probeResult');

    // Nh·ªõ BACKEND_URL trong localStorage
    (function initBackend(){
      const saved = localStorage.getItem('BACKEND_URL');
      if (saved) backendEl.value = saved;
    })();

    saveBackendEl.addEventListener('click', ()=>{
      const v = backendEl.value.trim();
      if (!v){ alert('Nh·∫≠p BACKEND_URL tr∆∞·ªõc khi l∆∞u.'); return; }
      localStorage.setItem('BACKEND_URL', v);
      setStatus('ƒê√£ l∆∞u BACKEND_URL v√†o tr√¨nh duy·ªát.');
    });

    // Autocomplete theo ti·ªÅn t·ªë to√†n chu·ªói
    cmdEl.addEventListener('keydown', (e) => {
      if (e.key === 'Tab') {
        e.preventDefault();
        const val = cmdEl.value.trim();
        const lower = val.toLowerCase();
        const matched = COMMANDS.filter(c => c.startsWith(lower));
        if (matched.length === 1) {
          const rest = val.slice(lower.length);
          cmdEl.value = matched[0] + rest;
        } else if (matched.length > 1) {
          matched.sort((a,b)=>a.length-b.length);
          const rest = val.slice(lower.length);
          cmdEl.value = matched[0] + rest;
        }
      }
    });

    // UI helpers
    function appendLog(msg, css='') {
      const line = document.createElement('div');
      if (css) line.className = css;
      line.textContent = msg;
      logsEl.appendChild(line);
      logsEl.scrollTop = logsEl.scrollHeight;
    }
    function setStatus(msg){ statusEl.textContent = msg; }

    // Tr√≠ch ID t·ª´ log (pattern: "ID: <...>")
    function extractIdsFromLog(text) {
      const ids = new Set();
      const re = /\bID\s*:\s*([A-Za-z0-9._\-]+)/ig;
      let m;
      while ((m = re.exec(text)) !== null) ids.add(m[1]);
      return Array.from(ids);
    }

    async function callJSON(url, body) {
      const res = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body || {})
      });
      if (!res.ok) {
        const t = await res.text().catch(()=> 'Request error');
        throw new Error(`HTTP ${res.status}: ${t}`);
      }
      return res.json();
    }

    // L∆∞u job g·∫ßn nh·∫•t: ƒë·ªÉ x√≥a d√≤ng l·ªói v√† t·∫£i file
    let lastJob = { data_dir: null, log_text: "" };

    // Ch·∫°y l·ªánh
    runBtn.addEventListener('click', async () => {
      const backend = backendEl.value.trim().replace(/\/+$/,'');
      const command = cmdEl.value.trim();
      if (!backend) { alert('Nh·∫≠p BACKEND_URL'); return; }
      if (!command) { alert('Nh·∫≠p l·ªánh'); return; }

      runBtn.disabled = true; deleteBtn.disabled = true;
      setStatus('ƒêang g·ª≠i l·ªánh...');
      logsEl.innerHTML = '';

      try {
        const start = await callJSON(`${backend}/api/run-tool`, { command });
        const jobId = start.job_id;
        appendLog(`üîé Job: ${jobId}`);

        let done = false, dataDir = null, resultText = '';
        while (!done) {
          const j = await fetch(`${backend}/api/job/${jobId}`).then(r=>r.json());
          if (j.status === 'done') {
            done = true;
            const r = j.result || {};
            resultText = (r.result ?? r.output ?? '') + '';
            dataDir = r.data_dir || null;
            if (resultText) appendLog(resultText);
            setStatus('Ho√†n t·∫•t.');
          } else if (j.status === 'error') {
            done = true;
            setStatus('L·ªói.');
            appendLog(`‚ùå ${j.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}`, 'error');
          } else {
            setStatus('ƒêang x·ª≠ l√Ω...');
            await new Promise(rs=>setTimeout(rs, 1000));
          }
        }

        lastJob = { data_dir: dataDir, log_text: resultText };
        const ids = extractIdsFromLog(resultText);
        deleteBtn.disabled = !(ids.length && dataDir);

        if (!dataDir) appendLog('‚ö†Ô∏è Kh√¥ng c√≥ data_dir t·ª´ server n√™n kh√¥ng th·ªÉ x√≥a d√≤ng l·ªói t·ª± ƒë·ªông.', 'error');
        else appendLog(`üìÅ Data dir: ${dataDir}`, 'muted');

        if (ids.length) appendLog(`üßæ Tr√≠ch ƒë∆∞·ª£c ${ids.length} ID l·ªói t·ª´ log.`);
        else appendLog('‚ÑπÔ∏è Kh√¥ng tr√≠ch ƒë∆∞·ª£c ID l·ªói n√†o trong log.', 'muted');
      } catch (e) {
        appendLog(`‚ùå ${e.message}`, 'error');
        setStatus('L·ªói.');
      } finally {
        runBtn.disabled = false;
      }
    });

    // X√≥a log
    clearBtn.addEventListener('click', () => {
      logsEl.innerHTML = '';
      setStatus('ƒê√£ x√≥a log.');
      deleteBtn.disabled = true;
    });

    // X√≥a d√≤ng l·ªói d·ª±a tr√™n log + t·ª± t·∫£i file ƒë√£ ch·ªânh s·ª≠a
    deleteBtn.addEventListener('click', async () => {
      const backend = backendEl.value.trim().replace(/\/+$/,'');
      if (!backend) { alert('Nh·∫≠p BACKEND_URL'); return; }
      if (!lastJob.data_dir) { alert('Ch∆∞a c√≥ data_dir. H√£y ch·∫°y tool tr∆∞·ªõc.'); return; }
      if (!lastJob.log_text) { alert('Ch∆∞a c√≥ log ƒë·ªÉ tr√≠ch ID.'); return; }

      try {
        // Dry-run ƒë·ªÉ ng∆∞·ªùi d√πng x√°c nh·∫≠n
        const dry = await callJSON(`${backend}/api/delete-error-lines`, {
          data_dir: lastJob.data_dir,
          log_text: lastJob.log_text,
          dry_run: true
        });
        const idsCount = (dry.ids || []).length;
        const files = dry.targets || [];
        if (!idsCount) { alert('Kh√¥ng t√¨m th·∫•y ID l·ªói trong log.'); return; }
        const ok = confirm(`S·∫Ω x√≥a c√°c d√≤ng ch·ª©a ${idsCount} ID trong ${files.length} file:\n- ${files.join('\n- ')}\n\nB·∫°n ch·∫Øc ch·∫Øn?`);
        if (!ok) return;

        // X√≥a th·∫≠t
        const res = await callJSON(`${backend}/api/delete-error-lines`, {
          data_dir: lastJob.data_dir,
          log_text: lastJob.log_text,
          dry_run: false
        });
        appendLog(`‚úÖ ƒê√£ x√≥a: ${res.deleted_total} d√≤ng trong ${res.reports.length} file.`, 'success');
        res.reports.forEach(r => {
          if (r.error) appendLog(`‚Ä¢ ${r.file}: ${r.error}`, 'error');
          else appendLog(`‚Ä¢ ${r.file}: removed ${r.removed}, kept ${r.kept}`);
        });

        // T·ª± ƒë·ªông t·∫£i file ƒë√£ ch·ªânh s·ª≠a
        const modified = res.modified_files || [];
        if (modified.length === 1) {
          const url = `${backend}/api/download-cleaned-one?data_dir=${encodeURIComponent(lastJob.data_dir)}&name=${encodeURIComponent(modified[0])}`;
          window.open(url, "_blank");
        } else if (modified.length > 1) {
          const url = `${backend}/api/download-cleaned?data_dir=${encodeURIComponent(lastJob.data_dir)}&names=${encodeURIComponent(modified.join(","))}`;
          window.open(url, "_blank");
        } else {
          appendLog('‚ÑπÔ∏è Kh√¥ng c√≥ file n√†o thay ƒë·ªïi (c√≥ th·ªÉ kh√¥ng line n√†o kh·ªõp ID).', 'muted');
        }
      } catch (e) {
        appendLog(`‚ùå ${e.message}`, 'error');
      }
    });

    // Ph√¢n t√≠ch link (probe quy·ªÅn chia s·∫ª + test t·∫£i nhanh)
    probeBtn.addEventListener('click', async () => {
      const backend = backendEl.value.trim().replace(/\/+$/,'');
      const url = probeUrlEl.value.trim();
      if (!backend) { alert('Nh·∫≠p BACKEND_URL'); return; }
      if (!url) { alert('Nh·∫≠p link c·∫ßn ph√¢n t√≠ch'); return; }
      probeBtn.disabled = true;
      probeResult.textContent = 'ƒêang ph√¢n t√≠ch...';
      try {
        const res = await callJSON(`${backend}/api/analyze-by-url`, { url });
        const vis = res.visibility || {};
        const ok = res.ok;
        const lines = [];
        lines.push(`K·∫øt qu·∫£: ${ok ? 'OK' : 'L·ªñI'}`);
        if (vis.public !== undefined) {
          lines.push(`Quy·ªÅn chia s·∫ª: ${vis.public ? 'C√¥ng khai / Truy c·∫≠p ƒë∆∞·ª£c' : 'Kh√¥ng c√¥ng khai'}`);
          if (vis.reason) lines.push(`L√Ω do: ${vis.reason}`);
        }
        const sum = (res.result && res.result.summary) || {};
        if (sum.num_entries_in_zip !== undefined) {
          lines.push(`S·ªë entry trong ZIP: ${sum.num_entries_in_zip}`);
          if (sum.sample_first_10 && sum.sample_first_10.length) {
            lines.push('V√≠ d·ª• 10 file ƒë·∫ßu:');
            sum.sample_first_10.forEach(n => lines.push('  - ' + n));
          }
        }
        probeResult.textContent = lines.join('\n');
      } catch (e) {
        probeResult.textContent = `L·ªói: ${e.message}`;
      } finally {
        probeBtn.disabled = false;
      }
    });

    // G·ª£i √Ω nhanh b·∫±ng click v√†o pill
    document.querySelectorAll('.pill').forEach(p => {
      p.addEventListener('click', () => {
        const cmd = p.textContent.trim();
        const cur = cmdEl.value.trim();
        if (!cur || !cur.startsWith(cmd)) {
          cmdEl.value = cmd + (cur ? (' ' + cur) : ' ');
          cmdEl.focus();
        }
      });
    });
  </script>
</body>
</html>
