<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tool Online: Chat • Upload ZIP • Google Drive Link</title>
  <!-- Tailwind CDN (dùng http/https, đừng mở file:// để tránh UI vỡ) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .spinner{border:3px solid #e5e7eb;border-top:3px solid #3b82f6;border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite;display:inline-block}
    @keyframes spin{100%{transform:rotate(360deg)}}
    pre { white-space: pre-wrap; }
  </style>
</head>
<body class="bg-gray-50">
  <div class="max-w-3xl mx-auto min-h-screen flex flex-col p-4">
    <header class="mb-4">
      <h1 class="text-xl font-semibold">Tool Online</h1>
      <p class="text-sm text-gray-600">Nhập lệnh, tải file ZIP, hoặc dán link Google Drive để phân tích.</p>
    </header>

    <main class="flex-1 overflow-y-auto">
      <div id="chatbox" class="space-y-3"></div>
    </main>

    <footer class="mt-4 space-y-3">
      <!-- Hàng nhập lệnh (Chat tới /api/run-tool) -->
      <div class="flex items-center gap-2">
        <input id="user-input" class="flex-1 border rounded-lg p-2 focus:outline-none focus:ring focus:border-blue-400"
               placeholder="Nhập lệnh (ví dụ: 'mi <link>', 'civitek <link>')..." />
        <button id="send-btn"
                class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-400">
          Gửi
        </button>
      </div>

      <!-- Hàng upload ZIP (POST /api/upload-files) -->
      <div class="flex items-center gap-2">
        <input id="file-upload" type="file" accept=".zip"
               class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none">
        <button id="file-upload-btn"
                class="bg-emerald-600 text-white px-3 py-2 rounded-lg hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 disabled:bg-gray-400">
          Tải lên
        </button>
      </div>
      <p id="file-name-display" class="text-xs text-gray-500 ml-1 truncate"></p>

      <!-- Hàng phân tích Google Drive link (POST /api/analyze-by-url) -->
      <div class="flex items-center gap-2">
        <input id="gdrive-link" class="flex-1 border rounded-lg p-2"
               placeholder="Dán link Google Drive (bật Anyone with the link)..." />
        <button id="gdrive-btn"
                class="bg-purple-600 text-white px-3 py-2 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500">
          Phân tích link
        </button>
      </div>
    </footer>
  </div>

  <script>
    // ======== CẤU HÌNH ========
    // Domain backend Render của bạn (KHÔNG có dấu / ở cuối)
    const BACKEND_URL = "https://python-chatbot-backend-0y5v.onrender.com";

    // ======== DOM refs ========
    const chatbox = document.getElementById('chatbox');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');

    const fileUploadInput = document.getElementById('file-upload');
    const fileUploadBtn = document.getElementById('file-upload-btn');
    const fileNameDisplay = document.getElementById('file-name-display');

    const gdriveInput = document.getElementById('gdrive-link');
    const gdriveBtn   = document.getElementById('gdrive-btn');

    // ======== Helpers UI ========
    function addMessage(text, sender, isHTML=false){
      const wrap=document.createElement('div');
      wrap.className=`flex ${sender==='user'?'justify-end':'justify-start'}`;
      const bubble=document.createElement('div');
      bubble.className=`rounded-lg px-4 py-2 max-w-xs md:max-w-md break-words shadow ${sender==='user'?'bg-blue-500 text-white':'bg-gray-200 text-gray-800'}`;
      if(isHTML) bubble.innerHTML=text; else bubble.textContent=text;
      wrap.appendChild(bubble);
      chatbox.appendChild(wrap);
      chatbox.scrollTop = chatbox.scrollHeight;
      return bubble; // trả về để cập nhật sau (loading → kết quả)
    }
    function makeProgressBlock(id){
      return `
        <div class="font-semibold mb-1">Đang tải lên:</div>
        <div id="${id}-name" class="text-sm truncate mb-2"></div>
        <div class="w-full bg-gray-300 rounded-full h-2.5">
          <div id="${id}-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width:0%"></div>
        </div>
        <div id="${id}-text" class="text-right text-xs mt-1 text-gray-600">0%</div>
      `;
    }

    // ======== Utils cho async run-tool ========
    const delay = (ms)=>new Promise(r=>setTimeout(r, ms));

    async function pollJob(jobId){
      while(true){
        const r = await fetch(`${BACKEND_URL}/api/job/${jobId}`);
        if(!r.ok) throw new Error(`Poll lỗi: ${r.status}`);
        const j = await r.json();
        if(j.status === 'done') return j.result;   // {result, module, fn, data_dir}
        if(j.status === 'error') throw new Error(j.error || 'Job failed');
        await delay(2000); // đợi 2s rồi hỏi lại
      }
    }

    async function runCommand(command){
      const r = await fetch(`${BACKEND_URL}/api/run-tool`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ command }),
        mode: 'cors'
      });

      // Server luôn trả 202 + job_id (bản backend mới). Nhưng vẫn hỗ trợ 200 cho backward compatibility.
      if(r.status === 200){
        return await r.json();
      }
      if(r.status === 202){
        const j = await r.json();
        if(!j.job_id) throw new Error('Không nhận được job_id');
        return await pollJob(j.job_id);
      }
      const txt = await r.text().catch(()=> '');
      throw new Error(`HTTP ${r.status}: ${txt}`);
    }

    // ======== Chat (/api/run-tool) ========
    async function handleSendCommand(){
      const command = userInput.value.trim();
      if(!command) return;
      addMessage(command, 'user');
      userInput.value=''; sendBtn.disabled=true;

      // tạo bubble loading để thay thế bằng kết quả khi xong
      const loadingBubble = addMessage('<div class="flex items-center gap-2"><div class="spinner"></div><span>Đang xử lý, vui lòng đợi...</span></div>', 'bot', true);

      try{
        const data = await runCommand(command);
        const text = data?.result ?? JSON.stringify(data);
        loadingBubble.innerHTML = `<pre class="text-sm">${text}</pre>`;
      }catch(e){
        loadingBubble.textContent = '❌ Lỗi kết nối/khởi chạy: ' + (e?.message || e);
      }finally{
        sendBtn.disabled=false;
      }
    }

    // ======== Upload ZIP trực tiếp (/api/upload-files) ========
    function handleUploadFile(){
      const file = fileUploadInput.files[0];
      if(!file){ addMessage('Bạn chưa chọn file nào.', 'bot'); return; }
      if(!file.name.endsWith('.zip')){ addMessage('Chỉ chấp nhận .zip', 'bot'); return; }

      const pid = 'pg-' + Date.now();
      addMessage(makeProgressBlock(pid), 'user', true);
      document.getElementById(`${pid}-name`).textContent = file.name;

      const fd = new FormData(); fd.append('file', file);
      const xhr = new XMLHttpRequest();
      xhr.open('POST', BACKEND_URL + '/api/upload-files', true); // KHÔNG set Content-Type thủ công

      xhr.upload.onprogress = (e)=>{
        if(e.lengthComputable){
          const pct = Math.round((e.loaded / e.total) * 100);
          const bar = document.getElementById(`${pid}-bar`);
          const label = document.getElementById(`${pid}-text`);
          if(bar) bar.style.width = pct + '%';
          if(label) label.textContent = pct + '%';
        }
      };

      xhr.onload = function(){
        // Gỡ progress block
        chatbox.removeChild(chatbox.lastChild);
        if(xhr.status === 200){
          const resp = JSON.parse(xhr.responseText);
          addMessage(`Tải lên thành công: ${resp.filename}`, 'user');
          if(resp.result){
            addMessage(`<pre class="text-xs md:text-sm">${JSON.stringify(resp.result, null, 2)}</pre>`, 'bot', true);
          }else{
            addMessage(`✅ Server đã lưu tạm tại:\n${resp.saved_to}`, 'bot');
          }
        }else{
          addMessage(`Tải lên thất bại: ${file.name}`, 'user');
          try{
            const err = JSON.parse(xhr.responseText);
            addMessage(`❌ Lỗi: ${err.error || xhr.statusText}`, 'bot');
          }catch{
            addMessage(`❌ Lỗi tải lên không xác định. Status: ${xhr.status}`, 'bot');
          }
        }
        resetUploadUI();
      };

      xhr.onerror = function(){
        chatbox.removeChild(chatbox.lastChild);
        addMessage(`❌ Tải lên thất bại: ${file.name}`, 'bot');
        addMessage('Kiểm tra mạng / preflight CORS (DevTools → Network).', 'bot');
        resetUploadUI();
      };

      fileUploadBtn.disabled = true; fileUploadBtn.textContent = 'Đang tải...';
      xhr.send(fd);
    }
    function resetUploadUI(){
      fileUploadBtn.disabled=false; fileUploadBtn.textContent = 'Tải lên';
      fileNameDisplay.textContent=''; fileUploadInput.value='';
    }

    // ======== Phân tích link Google Drive (/api/analyze-by-url) ========
    function extractDriveId(url){
      const m1 = url.match(/\/file\/d\/([^/]+)/); if(m1) return m1[1];
      const m2 = url.match(/[?&]id=([^&]+)/);    if(m2) return m2[1];
      return null;
    }
    async function handleAnalyzeDriveLink(){
      const raw = gdriveInput.value.trim();
      if(!raw){ addMessage('Bạn chưa dán link Drive.', 'bot'); return; }
      addMessage('Đang tải & phân tích từ Google Drive...', 'bot');

      let url = raw;
      if(/drive\.google\.com/.test(raw)){
        const id = extractDriveId(raw);
        if(!id){ addMessage('❌ Link Drive không hợp lệ.', 'bot'); return; }
        url = `https://drive.google.com/uc?export=download&id=${id}`;
      }

      try{
        const res = await fetch(BACKEND_URL + '/api/analyze-by-url', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ url }),
          mode: 'cors'
        });
        const data = await res.json();

        // Hiển thị trạng thái công khai (visibility) nếu có
        if (data.visibility) {
          if (data.visibility.public === false) {
            addMessage('❌ Link Drive chưa công khai. Vào Google Drive → Share → General access: "Anyone with the link".', 'bot');
            addMessage(`<pre class="text-xs md:text-sm">${JSON.stringify(data.visibility, null, 2)}</pre>`, 'bot', true);
          } else {
            addMessage(`✅ Link công khai: ${data.visibility.reason || 'OK'}`, 'bot');
          }
        }

        if(!res.ok || data.ok === false){
          addMessage('❌ Lỗi: ' + (data.error || res.statusText), 'bot'); return;
        }

        addMessage('✅ Đã phân tích xong ZIP.', 'bot');
        addMessage(`<pre class="text-xs md:text-sm">${JSON.stringify(data.result, null, 2)}</pre>`, 'bot', true);
      }catch(e){
        addMessage('❌ Lỗi kết nối/phân tích: ' + e.message, 'bot');
      }
    }

    // ======== Events ========
    sendBtn.addEventListener('click', handleSendCommand);
    userInput.addEventListener('keydown', e => { if(e.key==='Enter') handleSendCommand(); });

    fileUploadInput.addEventListener('change', ()=>{
      fileNameDisplay.textContent = fileUploadInput.files[0] ? `Đã chọn: ${fileUploadInput.files[0].name}` : '';
    });
    fileUploadBtn.addEventListener('click', handleUploadFile);

    gdriveBtn.addEventListener('click', handleAnalyzeDriveLink);

    // Lời chào
    addMessage('Chào bạn, tôi là bot trợ lý. Hãy nhập lệnh, tải ZIP, hoặc dán link Google Drive để phân tích.', 'bot');
  </script>
</body>
</html>
